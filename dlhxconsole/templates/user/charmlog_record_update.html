{% extends "user/index.html" %} {% block title %} {{ super() }}{% endblock title %} {% block head %} {{ super() }}
<link rel="stylesheet" type="text/css" media="screen" href={{url_for('static', filename='css/timeline-style.css')}} />

<script type="text/javascript">
    $(document).ready(function() {
    });

    function update(logid, recordid){
        var url = '/{{session.appname}}/charmlog/record/update?entry=mine'
        var imgurls = new Array();
        for(var i=0; i<$('#record-img-div').children('div').length; i++){
            imgurls.push($('#record-img-div').children('div').eq(i).find('img').attr('src').split('@!')[0])
        }
        data = {
            'logid': logid,
            'recordid': recordid,
            'title': $("#record-title").val(),
            'detail': $("#record-detail").val(),
            'imgurls': imgurls.join('&'),
            'cover': $("#record-cover").val(),
            'suggestion': $("#record-suggestion").val()
        }
        ajax(url, data, function(data){
            showtoast(data.msg);
            window.location.href='/{{session.appname}}/charmlog/update?entry=mine&logid='+logid
        })
    }
</script>
<style type="text/css">
    .file-preview-frame {
        display: table;
        margin: 8px;
        height: 160px;
        border: 1px solid #ddd;
        box-shadow: 1px 1px 5px 0px #a2958a;
        padding: 6px;
        float: left;
        text-align: center;
        vertical-align: middle;
    }

    .file-preview-frame:hover {
        box-shadow: 3px 3px 5px 0px #333;
    }

    .file {
        position: relative;
        display: inline-block;
        background: #428bca;
        border: 1px solid #357ebd;
        border-radius: 4px;
        padding: 4px 12px;
        overflow: hidden;
        color: #fff;
        font-size: 15px;
        text-decoration: none;
        text-indent: 0;
        line-height: 20px;
    }
    .file input {
        position: absolute;
        font-size: 100px;
        right: 0;
        top: 0;
        opacity: 0;
    }
    .file:hover {
        background: #3276b1;
        border-color: #285e8e;
        color: #fff;
        text-decoration: none;
    }
    .record-img-preview {
        width: 100px;
        height: 100px;
    }
</style>
{% endblock head %} {% block right_content %}
<div class="panel-group" id="accordion">
    <form id='record-form' class="form-horizontal" action="" method='post'>
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">修改日记记录</h3>
            </div>

            <div class="panel-body">
                <div class="form-group">
                    <label class="col-sm-2 control-label" style="padding-top: 0;">日记标题</label>
                    <div class="col-sm-5">
                        <input type='text' class='form-control' id="record-title" name='title' value="{{form.title or record.title or ''}}" placeholder="日记标题" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label" style="padding-top: 0;">日记描述</label>
                    <div class="col-sm-5">
                        <textarea name="detail" class="form-control" style="width:100%" id="record-detail" rows="5" placeholder="日记描述" required> {{form.detail or record.detail or ''}} </textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-2 control-label" style="padding-top: 0;">专家建议</label>
                    <div class="col-sm-5">
                        <textarea name="suggestion" class="form-control" style="width:100%" id="record-suggestion" rows="5" placeholder="专家建议" required>{{form.suggestion or record.suggestion or ''}}</textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-2 control-label">最佳印象</label>
                    <div class="col-sm-5" style="position: relative;">
                        <div class="input-group">
                          <input type="text" class="form-control" id="record-cover" name="cover" value="{{form.cover or record.cover or ''}}" />
                          <span class="input-group-btn">
                            <button class="btn btn-success buddy_uploadimage_btn" type="button" >+</button>
                            <input class="buddy_uploadimage_input" style="opacity: 0;" type='file' name='image-file' accept="image/jpeg,image/png">
                          </span>
                        </div>
                        <img style="width: 200px;" src="{{form.cover or record.cover or ''}}" />
                    </div>
                </div>

                <div id="uploadfile-record-div" class="form-group">
                        <label class="col-sm-2 control-label" style="padding-top: 0;">今日秀图</label>
                        <div class="file">
                            <i class="glyphicon glyphicon-folder-open"></i>&nbsp<span>上传图片</span>
                            <input type="file" id="uploadfile" name="uploadfile" onchange="upload('{{record.logid}}', this.files)" value="">
                        </div>
                </div>

                <div id="record-img-div" class="form-group">
                    {% if record.imgurls %}
                        {% for url in record.imgurls %}
                        <!-- <label class="col-sm-2 control-label" style="padding-top: 0;"></label> -->
                            <div class="col-md-4 file-preview-frame">
                                <img data-toggle="modal" data-target="#imgModal" data-whatever='{"imgurl":"{{url}}"}' src="{{url}}@!falythumbnail" alt="图片加载失败" >
                                <div tabindex="-1">
                                    <div image-id="{{ url }}" data-logid="{{record.logid}}" class="record-file-remove btn btn-xs btn-default" style="float:right">
                                        <i style="font-size:16px" class="glyphicon glyphicon-trash text-danger"></i>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}

                    {% endif %}
                </div>

                <div class="form-group">
                    <label class="col-sm-2 control-label" style="padding-top: 0;"></label>
                    <div class="col-sm-2">
                        <button type="button" onclick="update('{{record.logid}}', '{{record.recordid}}')" class="btn btn-success btn-block">保存</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<div class="modal fade" id="imgModal" tabindex="-1" role="dialog" aria-labelledby="imgModalLabel">
    <div class="modal-dialog" style="" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span></button>
            </div>
            <div style="width:100%;max-height:700px;overflow:scroll;text-align:center">
                <img id="view-img" src="" alt="不能显示该项" style="width:100%">
            </div>
            <div class="modal-footer" style="text-align: center">
                <button class="btn btn-default" type="button" id="prev-img">上一张</button>
                <button class="btn btn-default" type="button" id="next-img">下一张</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">

$('#imgModal').on('show.bs.modal', function(event) {
    var imgbtn = $(event.relatedTarget) // 触发事件的按钮
    var data = imgbtn.data('whatever') // 解析出data-whatever内容
    var modal = $(this)
    modal.find("#view-img").attr('src',data.imgurl)
    $("#next-img").click(function(){
        if(imgbtn.parent().next().attr("class")=="col-md-4 file-preview-frame" || imgbtn.parent().next().attr("class")=="col-md-3 file-preview-frame"){
            modal.find("#view-img").attr('src',imgbtn.parent().next().find("img").data("whatever").imgurl)
            imgbtn = imgbtn.parent().next().find("img")
        }
    });
    $("#prev-img").click(function(){
        if(imgbtn.parent().prev().attr("class")=="col-md-4 file-preview-frame" || imgbtn.parent().prev().attr("class")=="col-md-3 file-preview-frame"){
            modal.find("#view-img").attr('src',imgbtn.parent().prev().find("img").data("whatever").imgurl)
            imgbtn = imgbtn.parent().prev().find("img")
        }
    })
});

$(".record-file-remove").bind('click', function(){
    $(this).parent().parent().fadeOut('slow', function(){
        $(this).remove()
    })
});
function upload(logid, files) {
    if (files[0] == undefined) {
        return
    }
    var url = '/{{session.appname}}/charmlog/record/file/upload/ajax'
    var imgDate = files[0].lastModifiedDate
    var img_ct = imgDate.getFullYear()+'-'+imgDate.getMonth()+'-'+imgDate.getDay()+' '+imgDate.getHours()+':'+imgDate.getMinutes()+':'+imgDate.getSeconds();
    var formData = new FormData()
    formData.append("logid", logid)
    formData.append("uploadfile", files[0])
    $.ajax({
        url: url,
        data: formData,
        type: 'post',
        /**
         *必须false才会自动加上正确的Content-Type
         */
        contentType: false,
        /**
         * 必须false才会避开jQuery对 formdata 的默认处理
         * XMLHttpRequest会对 formdata 进行正确的处理
         */
        processData: false,
        success: function(data) {
            var data = data.data
            var btnstr = '<div data-logid="'+data.logid+'" class="record-file-remove btn btn-xs btn-default" style="float:right"><i style="font-size:16px" class="glyphicon glyphicon-trash text-danger"></i></div>'
            $("#uploadfile-record-div").next().append(
                '<div class="col-md-3 file-preview-frame"><img data-toggle="modal" data-target="#imgModal" data-whatever=\'{"imgurl":"'+data.imgurl+'"}\' src="'+data.imgurl+'@!falythumbnail" alt="不能显示该项"><div tabindex="-1">'+btnstr+'</div></div>'
            );
            $(".record-file-remove").bind('click', function(){
                $(this).parent().parent().fadeOut('slow', function(){
                    $(this).remove()
                })
            });
        }
    });
};
</script>
{% endblock right_content %}
