{% extends "user/index.html" %} {% block title %} {{ super() }}{% endblock title %} {% block head %} {{ super() }}
<script type="text/javascript">
    $(document).ready(function() {
        $('.team-search').each(function() {
            $(this).click(function() {
                window._team_search_name = $(this);
                window._team_search_teamid = window._team_search_name.prev();
                window._team_search_left = document.body.scrollLeft;
                window._team_search_top = document.body.scrollTop;
                //展示搜索框
                $('#team-search-dev').show();
                // $('#team-search-name').focus();
                $('#team-search-submit').click();
            });
        });
        $('#team-search-cancel').click(function() {
            $('#team-search-dev').hide();
        });
        $('#team-search-clear').click(function() {
            window._team_search_name.val('');
            window._team_search_teamid.val('');
            $('#team-search-dev').hide();
            window._team_search_name.change();
        });
        $('#team-search-submit').click(function(e) {
            e.preventDefault()
            //删除上次查询记录
            $('#team-search-list').empty();
            //输入为空，忽略操作
            // var name = $(this).prev().val();
            // if (name == '') {
            //     return
            // }
            var url = "/{{session.appname}}/serviceteam/team/query/ajax"
            var data = {
                // 'name': name
            }
            ajax(url, data, function(data) {
                for (var k in data) {
                    for (var i in data.teams) {
                        //构造一个可点击的用户对象
                        var team = data.teams[i];
                        var logourl = ''
                        if(team.logourl){
                            logourl = team.logourl
                        }
                        var _oneteamdom = $('' +
                            '<div class="list-group">' +
                            '<input type="hidden" value="' + team.teamid + '|' + team.name + '" />' +
                            '<a href="#" class="list-group-item">' +
                            '<img src="'+ logourl +'" style="border-radius:50%;width: 50px; margin-right: 10px;"><br>' +
                            '<h5 class="list-group-item-heading">团队名称：' + team.name + '</h5>' +
                            '<p class="list-group-item-text">团队标语：' + team.slogan + '</p>' +
                            '</a>' +
                            '</div>')
                        _oneteamdom.click(function(e) {
                            //此处必须阻止事件传递，不然窗口会默认滚动当前界面到该被点击的元素位置。
                            e.preventDefault();
                            var tmp = $(this).find('input').first().val();
                            var teamid = tmp.split('|')[0];
                            var name = tmp.split('|')[1];
                            window._team_search_name.val(name);
                            window._team_search_teamid.val(teamid);
                            $('#team-search-dev').hide();
                            window._team_search_name.focus();
                            //滚动到原来位置
                            window.scrollTo(window._team_search_left, window._team_search_top);
                            window._team_search_name.change();
                        });
                        $('#team-search-list').append(_oneteamdom);
                    }
                }
            });
        });

        $("#add-team-form").submit(function(e){
            // 阻止表单提交事件
            e.preventDefault();
            $("#add-team-btn").attr("disabled","disabled");
            var url = "/{{session.appname}}/serviceteam/add/team/ajax"
            var uid = $("#target_uid").val()
            var teamid = $("#teamid").val()

            var data = {
                'teamid': teamid,
                'uid': uid
            }
            ajax(url, data, function(data) {
                if(data.code=="0"){
                    showtoast("该团队已服务于该用户！")
                    return
                }
                var count = parseInt($("#total_count").attr("data-count-value"))
                var ust = data.ust;
                var rdict = data.rdict;
                var str0 = '<tr><td style="position: relative; "><b><span style="display: block; border: 1px solid #ccc; width: 20px; height: 20px; border-radius: 10px; line-height: 20px; text-align: center; margin-bottom: 5px;">'+(count+1)+'</span></b>'
                var logourl = ''
                if(ust.team.logourl){
                    logourl = ust.team.logourl
                }
                var logoimg = '<img src="'+ logourl +'" style="border-radius:50%;width: 50px; margin-right: 10px;"><br>'
                var str1 = '<b>是否主团队：</b>否<br><b>团队名称：</b><span>'+ ust.team.name +'</span><br><b>团队标语：</b><span>'+ ust.team.slogan +'</span><br><b>团队成员：</b>'
                var str2 = ''
                for(var r in rdict){
                    str2 += '<br><b style="margin-left:20px;color:purple">'+ rdict[r] +'：</b>';
                    var members = ust.team.members
                    for(var m in members){
                        if(members[m].roleid == r){
                            str2 += '<span style="margin:0 5px 0 5px;color:orange">'+ members[m].membername +' </span>'
                        }
                    }
                }
                $("#teamid").val("");
                $("#teamid").next().val("");
                var str3 = '<br><a class="buddy-btn-a" id="'+ ust.ustid +'" onclick="removeTeam(\''+ ust.ustid +'\')" href="#">删除</a>'
                var str4 = '<a class="buddy-btn-a" href="/{{session.appname}}/serviceteam/setmain/team/ajax/true?entry=mine&ustid='+ust.ustid+'">设为主团队</a></td></tr>'
                var str = str0 + logoimg + str1 + str2 + str3 + str4
                $("#team-tbody").append(str);
                $("#total_count").attr("data-count-value",count+1)
                $("#total_count").text(count+1)
                $("#add-team-btn").removeAttr("disabled")
                showtoast("添加成功！")
            });
        });

    });

    function removeTeam(ustid){
        if(confirm('您确定要执行此操作吗？')){
            var url = "/{{session.appname}}/serviceteam/delete/team/ajax"
            data = {
                'ustid': ustid
            }
            ajax(url, data, function(data){
                showtoast(data.msg);
                window.location.href='/{{session.appname}}/serviceteam/team/query?entry=mine&target_uid={{form.uid}}'
                // $("#"+ustid).parent().parent().fadeOut('slow', function(){
                //     $(this).remove();
                // });

            });
        }
    }
</script>
<style type="text/css">

</style>
{% endblock head %} {% block right_content %}
<div class='.container-fluid'>
    <div class='row' style="margin: 0">
        <div class='col-md-12' style="padding: 0">
            <form id='add-team-form' class="form-inline" action="/{{session}}/serviceteam/add/team/ajax" method='post'>
                <div class="form-group">
                    <input type="hidden" id="target_uid" name="uid" value="{{ form.uid or '' }}">
                    <input type="hidden" id="teamid" name="teamid" value="{{ form.teamid or ''}}">
                    <input type="text" class="form-control team-search" name="name" value="{{ form.name or '' }}" placeholder="团队名称" required>
                </div>
                <button id="add-team-btn" type="submit" class="btn btn-success">添加团队</button>
            </form>

        </div>
    </div>
    <div clas='row' style='margin-top: 20px;'>
        <div class='col-md-12' style="padding-left: 0">

            <table class="table table-bordered table-condensed table-hover">
                <tbody id="team-tbody">
                    {# 遍历展示团队列表 #}
                    {% if total_count==0 %}
                    <!-- 如果查询数量为“0”，则将默认团队放到第一位 -->
                        <tr>
                            <td style="position: relative; ">
                                <b><span style="display: block; border: 1px solid #ccc; width: 20px; height: 20px; border-radius: 10px; line-height: 20px; text-align: center; margin-bottom: 5px;">1</span></b>
                                <img  style="position:absolute;display: block;right:5px;width:35px" src="https://images.buddydc.com/rs/faly/1501254869022_735be28673a711e7ae0ca0c589188e1d.png" alt="">
                                <br>
                                <img src="{{defaultteam.logourl or ''}}" style="border-radius:50%;width: 50px; margin-right: 10px;"><br>
                                <b>是否主团队：</b>否
                                <br><b>团队名称：</b><span>{{defaultteam.name}}</span><br>
                                <b>团队标语：</b><span>{{defaultteam.slogan}}</span><br>
                                <b>团队负责人：</b><span>{{defaultteam.manager.get('name') or ''}}</span><br>
                                <b>团队成员：</b> {% for roleid, name in rdict.items() %}
                                <br><b style="margin-left:20px;color:purple">{{ name }}：</b> {% for m in defaultteam.members %} {% if m.roleid == roleid %}
                                <span style="margin:0 5px 0 5px;color:orange">{{ m.membername }}</span> {% endif %} {% endfor %} {% endfor %}
                                <br>
                            </td>
                        </tr>
                    {% else %}
                        {% if hasmainteam=='true' %}
                        <!-- 如果该用户拥有主团队 -->
                            {% for ust in usts %}
                                {% if loop.index==2 %}
                                <!-- 将默认团队放到主团队后面（第二位） -->
                                    <tr>
                                        <td style="position: relative; ">
                                            <b><span style="display: block; border: 1px solid #ccc; width: 20px; height: 20px; border-radius: 10px; line-height: 20px; text-align: center; margin-bottom: 5px;">{{loop.index}}</span></b>
                                            <img  style="position:absolute;display: block;right:5px;width:35px" src="https://images.buddydc.com/rs/faly/1501254869022_735be28673a711e7ae0ca0c589188e1d.png" alt="">
                                            <br>
                                            <img src="{{ust.logourl or ''}}" style="border-radius:50%;width: 50px; margin-right: 10px;"><br>
                                            <b>是否主团队：</b>否
                                            <br><b>团队名称：</b><span>{{ust.name}}</span><br>
                                            <b>团队标语：</b><span>{{ust.slogan}}</span><br>
                                            <b>团队负责人：</b><span>{{ust.manager.get('name') or ''}}</span><br>
                                            <b>团队成员：</b> {% for roleid, name in rdict.items() %}
                                            <br><b style="margin-left:20px;color:purple">{{ name }}：</b> {% for m in ust.members %} {% if m.roleid == roleid %}
                                            <span style="margin:0 5px 0 5px;color:orange">{{ m.membername }}</span> {% endif %} {% endfor %} {% endfor %}
                                            <br>
                                        </td>
                                    </tr>
                                    {% else %}
                                        <tr>
                                            <td style="position: relative; ">
                                                <b><span style="display: block; border: 1px solid #ccc; width: 20px; height: 20px; border-radius: 10px; line-height: 20px; text-align: center; margin-bottom: 5px;">{{loop.index}}</span></b>
                                                {% if ust.ismain %}
                                                <img  style="position:absolute;display: block;right:5px;width:35px" src="https://images.buddydc.com/rs/faly/1501229232640_c2e26f3c736b11e7bd25a0c589188e1d.png" alt="">
                                                {% endif %}
                                                <br>
                                                <img src="{{ust.team.logourl or ''}}" style="border-radius:50%;width: 50px; margin-right: 10px;"><br>
                                                <b>是否主团队：</b>{{'是' if ust.ismain else '否'}}
                                                <br><b>团队名称：</b><span>{{ust.team.name}}</span><br>
                                                <b>团队标语：</b><span>{{ust.team.slogan}}</span><br>
                                                <b>团队负责人：</b><span>{{ust.team.manager.get('name') or ''}}</span><br>
                                                <b>团队成员：</b> {% for roleid, name in rdict.items() %}
                                                <br><b style="margin-left:20px;color:purple">{{ name }}：</b> {% for m in ust.team.members %} {% if m.roleid == roleid %}
                                                <span style="margin:0 5px 0 5px;color:orange">{{ m.membername }}</span> {% endif %} {% endfor %} {% endfor %}
                                                <br>
                                                <a class="buddy-btn-a" id="{{ ust.ustid }}" onclick="removeTeam('{{ ust.ustid }}')" href="#">删除</a>
                                                {% if ust.ismain %}
                                                    <a class="buddy-btn-a" href="/{{session.appname}}/serviceteam/setmain/team/ajax/false?entry=mine&ustid={{ust.ustid}}">取消主团队</a>
                                                {% else %}
                                                    <a class="buddy-btn-a" href="/{{session.appname}}/serviceteam/setmain/team/ajax/true?entry=mine&ustid={{ust.ustid}}">设为主团队</a>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endif %}
                            {% endfor %}
                        {% else %}
                        <!-- 如果该用户没有主团队 -->
                            {% for ust in usts %}
                                {% if loop.index==1 %}
                                <!-- 将默认团队放到第一位 -->
                                    <tr>
                                        <td style="position: relative; ">
                                            <b><span style="display: block; border: 1px solid #ccc; width: 20px; height: 20px; border-radius: 10px; line-height: 20px; text-align: center; margin-bottom: 5px;">{{loop.index}}</span></b>
                                            <img  style="position:absolute;display: block;right:5px;width:35px" src="https://images.buddydc.com/rs/faly/1501254869022_735be28673a711e7ae0ca0c589188e1d.png" alt="">
                                            <br>
                                            <img src="{{ust.logourl or ''}}" style="border-radius:50%;width: 50px; margin-right: 10px;"><br>
                                            <b>是否主团队：</b>否
                                            <br><b>团队名称：</b><span>{{ust.name}}</span><br>
                                            <b>团队标语：</b><span>{{ust.slogan}}</span><br>
                                            <b>团队负责人：</b><span>{{ust.manager.get('name') or ''}}</span><br>
                                            <b>团队成员：</b> {% for roleid, name in rdict.items() %}
                                            <br><b style="margin-left:20px;color:purple">{{ name }}：</b> {% for m in ust.members %} {% if m.roleid == roleid %}
                                            <span style="margin:0 5px 0 5px;color:orange">{{ m.membername }}</span> {% endif %} {% endfor %} {% endfor %}
                                            <br>
                                        </td>
                                    </tr>
                                {% else %}
                                    <tr>
                                        <td style="position: relative; ">
                                            <b><span style="display: block; border: 1px solid #ccc; width: 20px; height: 20px; border-radius: 10px; line-height: 20px; text-align: center; margin-bottom: 5px;">{{loop.index}}</span></b>
                                            {% if ust.ismain %}
                                            <img  style="position:absolute;display: block;right:5px;width:35px" src="https://images.buddydc.com/rs/faly/1501229232640_c2e26f3c736b11e7bd25a0c589188e1d.png" alt="">
                                            {% endif %}
                                            <br>
                                            <img src="{{ust.team.logourl or ''}}" style="border-radius:50%;width: 50px; margin-right: 10px;"><br>
                                            <b>是否主团队：</b>{{'是' if ust.ismain else '否'}}
                                            <br><b>团队名称：</b><span>{{ust.team.name}}</span><br>
                                            <b>团队标语：</b><span>{{ust.team.slogan}}</span><br>
                                            <b>团队负责人：</b><span>{{ust.team.manager.get('name') or ''}}</span><br>
                                            <b>团队成员：</b> {% for roleid, name in rdict.items() %}
                                            <br><b style="margin-left:20px;color:purple">{{ name }}：</b> {% for m in ust.team.members %} {% if m.roleid == roleid %}
                                            <span style="margin:0 5px 0 5px;color:orange">{{ m.membername }}</span> {% endif %} {% endfor %} {% endfor %}
                                            <br>
                                            <a class="buddy-btn-a" id="{{ ust.ustid }}" onclick="removeTeam('{{ ust.ustid }}')" href="#">删除</a>
                                            {% if ust.ismain %}
                                                <a class="buddy-btn-a" href="/{{session.appname}}/serviceteam/setmain/team/ajax/false?entry=mine&ustid={{ust.ustid}}">取消主团队</a>
                                            {% else %}
                                                <a class="buddy-btn-a" href="/{{session.appname}}/serviceteam/setmain/team/ajax/true?entry=mine&ustid={{ust.ustid}}">设为主团队</a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    {% endif %}
                </tbody>
            </table>
            共<span id="total_count" data-count-value="{{ total_count+1 }}" style="color:green">{{total_count+1}}</span>条
        </div>
    </div>
</div>

<div id="team-search-dev" class="container-fluid" style="position: fixed; top: 0; left: 0; z-index: 1000; width: 100%; height: 100%; background:rgba(0, 0, 0, 0.8); display: none;">
    <div class='.container-fluid' style="width: 90%; height: 80%; overflow-y:scroll; margin-top: 5%; margin-left: 5%; background-color: #fafafa; padding: 10px;">
        <div class='row'>
            <div class='col-md-8'>
                <form id='query-form' class="form-inline" method='post'>
                    <div class="form-group">
                        <!-- <input id="team-search-name" type="text" style="display:none" class="form-control" placeholder="团队名称" name='name'> -->
                        <button type="button" id="team-search-submit" style="display:none" class="btn btn-success">查询</button>
                        <button type="button" id="team-search-cancel" class="btn btn-success">取消</button>
                        <button type="button" id="team-search-clear" class="btn btn-success">清空</button>
                    </div>
                </form>
            </div>
        </div>
        <div id="team-search-list" class='row' style='margin-top: 20px;'></div>
    </div>
</div>

{% endblock right_content %}
